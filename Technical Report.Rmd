---
title: "Technical Report"
author: "Evan Pugh"
date: "12/1/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(glmnet)
library(tidyverse)
library(broom)
library(glmnet)
library(ggplot2)
library(tree)
library(imager)
library(dplyr)
library(ISLR)
OECD <- load.image("https://upload.wikimedia.org/wikipedia/commons/thumb/4/4c/OECD_member_states_map.svg/2560px-OECD_member_states_map.svg.png")

```

### Abstract

This project seeks to analyze what factors effect the death rate behind specific illnesses. The illnesses we have chosen to analyze are HIV-AIDs, Influenza, Tuberculosis, Neoplasms (tumors) and Pneumonia.

### Introduction

Our data comes from the OECD, or Organisation for Economic Co-operation and Development. The OECD is a group of nations who share data that they have gathered about themselves in order to seek solutions to shared problems, identify good policies and coordinate efforts between member countries.  Here is a map highlighting all 36 nations in the OECD:
```{r}
plot(OECD, axes = FALSE)

```
As you can probably tell from looking at the map, most of the countries on this map are countries that have a high income per capita and a high Human Development Index. In addition to these 36 countries, our data set also contains data on Brazil, Colombia, Costa Rica, Russia and South Africa. For this analysize we have choosen to measure data from 1990 to 2016


#### Exploratory Data Analysis

```{r}
death_rates <- read_csv("data/death_rates.csv")
employment <- read_csv("data/employment.csv")
GDPs <- read_csv("data/GDPs.csv")
insurance <- read_csv("data/insurance.csv")
populations <- read_csv("data/populations.csv")
PublicExp <- read_csv("data/PublicExp.csv")
GovtExp <- read_csv("data/GovtExp.csv")
employment = employment[employment$Measure=="Density per 1 000 population (head counts)",]
employment = cbind(employment[6],employment[8:9])

death_rates = cbind(death_rates[2],death_rates[6],death_rates[8:9])
GDPs = cbind(GDPs[6],GDPs[8:9])
populations = cbind(populations[6],populations[8:9])
insurance = cbind(insurance[6],insurance[8:9])
GovtExp = cbind(GovtExp[10],GovtExp[12],GovtExp[19])
PublicExp = cbind(PublicExp[10],PublicExp[12],PublicExp[19])

```

Let's start by plotting the number of deaths per 100,000 people for each of our five causes of death by year. Each of the 41 countries has been given a unique color and shape combination in order to indentify it and track it.

```{r}
colors = rep(c("black","red","blue","green","violet","yellow","orange"),6)
shapes = rep(c(1,2,3,4,5,6),7)

death_rates=death_rates[death_rates$Year>1989,]
HIV = death_rates[death_rates$Variable == "HIV-AIDS",]
Flu = death_rates[death_rates$Variable == "Influenza",]
Tub = death_rates[death_rates$Variable == "Tuberculosis",]
Neo = death_rates[death_rates$Variable == "Neoplasms",]
Pne= death_rates[death_rates$Variable == "Pneumonia",]

ggplot(final, aes(x=Year, y=HIV,color=Country,shape=Country)) + geom_point()+
  scale_shape_manual(values=shapes[0:41])+
  scale_color_manual(values=colors[0:41])
  
ggplot(Flu, aes(x=Year, y=Value,color=Country,shape=Country)) + geom_point()+
  scale_shape_manual(values=shapes[0:41])+
  scale_color_manual(values=colors[0:41])

ggplot(Tub, aes(x=Year, y=Value,color=Country,shape=Country)) + geom_point()+
  scale_shape_manual(values=shapes[0:41])+
  scale_color_manual(values=colors[0:41])

ggplot(Neo, aes(x=Year, y=Value,color=Country,shape=Country)) + geom_point()+
  scale_shape_manual(values=shapes[0:41])+
  scale_color_manual(values=colors[0:41])

ggplot(Pne, aes(x=Year, y=Value,color=Country,shape=Country)) + geom_point()+
  scale_shape_manual(values=shapes[0:41])+
  scale_color_manual(values=colors[0:41])
```



```{r}
final = death_rates[,2:3]
final = unique(final)
final = left_join(final,HIV[,2:4], by = c("Country"="Country","Year"="Year"))
names(final) <- c("Country","Year", "HIV-Aids")

final = left_join(final,Flu[,2:4], by = c("Country"="Country","Year"="Year"))
names(final) <- c("Country","Year", "HIV-Aids","Influenza")

final = left_join(final,Tub[,2:4], by = c("Country"="Country","Year"="Year"))
names(final) <- c("Country","Year", "HIV-Aids","Influenza","Tuberculosis")

final = left_join(final,Neo[,2:4], by = c("Country"="Country","Year"="Year"))
names(final) <- c("Country","Year", "HIV-Aids","Influenza","Tuberculosis","Neoplasms")

final = left_join(final,Pne[,2:4], by = c("Country"="Country","Year"="Year"))
names(final) <- c("Country", "Year", "HIV-Aids", "Influenza", "Tuberculosis", "Neoplasms", "Pneumonia")

final = left_join(final,employment, by = c("Country"="Country","Year"="Year"))
names(final) <- c("Country", "Year", "HIV-Aids", "Influenza", "Tuberculosis", "Neoplasms", "Pneumonia","Employment")

final = left_join(final,populations, by = c("Country"="Country","Year"="Year"))
names(final) <- c("Country", "Year", "HIV-Aids", "Influenza", "Tuberculosis", "Neoplasms", "Pneumonia","Employment","Population")

final = left_join(final,GDPs, by = c("Country"="Country","Year"="Year"))
names(final) <- c("Country", "Year", "HIV", "Influenza", "Tuberculosis", "Neoplasms", "Pneumonia","Employment","Population", "GDP")

final = left_join(final,insurance, by = c("Country"="Country","Year"="Year"))
names(final) <- c("Country", "Year", "HIV", "Influenza", "Tuberculosis", "Neoplasms", "Pneumonia","Employment","Population", "GDP","Coverage")

final = left_join(final,GovtExp, by = c("Country"="Country","Year"="Year"))
names(final) <- c("Country", "Year", "HIV", "Influenza", "Tuberculosis", "Neoplasms", "Pneumonia","Employment","Population", "GDP","Coverage","GovtExp")

final = left_join(final,PublicExp, by = c("Country"="Country","Year"="Year"))
names(final) <- c("Country", "Year", "HIV", "Influenza", "Tuberculosis", "Neoplasms", "Pneumonia","Employment","Population", "GDP","Coverage","GovtExp","PublicExp")

final = unique(final)

HIV = final[final$Variable == "HIV-AIDS",]
Flu = final[final$Variable == "Influenza",]
Tub = final[final$Variable == "Tuberculosis",]
Neo = final[final$Variable == "Neoplasms",]
Pne= final[final$Variable == "Pneumonia",]
```


#### Exercise 4

```{r}
mHIV = lm(final$HIV ~ final$Year + final$Employment + final$Population + final$GDP + final$Coverage + final$GovtExp + final$PublicExp)
summary(mHIV)

mFlu = lm(final$Influenza ~ final$Year + final$Employment + final$Population + final$GDP + final$Coverage + final$GovtExp + final$PublicExp)
summary(mFlu)

mTub = lm(final$Tuberculosis ~ final$Year + final$Employment + final$Population + final$GDP + final$Coverage + final$GovtExp + final$PublicExp)
summary(mTub)

mPne = lm(final$Pneumonia ~ final$Year + final$Employment + final$Population + final$GDP + final$Coverage + final$GovtExp + final$PublicExp)
summary(mPne)

mNeo = lm(final$Neoplasms~ final$Year + final$Employment + final$Population + final$GDP + final$Coverage + final$GovtExp + final$PublicExp)
summary(mNeo)
```

So in summary:

Our model for HIV had an R-squared of 0.2273 and found that the Year, Employment, Coverage, and Public Expenditure were statistically significant variables.

Our model for Influenza had an R-squared of 0.3002 and found that the Year, Employment,Population and GDP were statistically significant variables (Public Expenditure just missed the cutoff).

Our model for Tuberculosis had an R-squared of 0.3575 and found that the Population, Coverage, Government Expenditure and Public Expenditure were statistically significant variables.

Our model for Pneumonia had an R-squared of 0.2719 and found that all of our variables were statistically significant variables.

Our model for Neoplasms had an R-squared of 0.3741 and found that the Year, Population, GDP Coverage, and Government Expenditure were statistically significant variables.

Now, undoubtally there are some variables effecting this data that are not in this data set. There are a tens of thousands of  variables that could effect these death rates, everything from the climate to the form of government. To try and account for many of these, let's add Country to the list of variables as a proxy for the variables that we have not accounted for but are mostly static for a given country.

```{r}

m2HIV = lm(final$HIV ~ final$Year + final$Employment + final$Population + final$GDP + final$Coverage + final$GovtExp + final$PublicExp + final$Country)
summary(m2HIV)

m2Flu = lm(final$Influenza ~ final$Year + final$Employment + final$Population + final$GDP + final$Coverage + final$GovtExp + final$PublicExp + final$Country)
summary(m2Flu)

m2Tub = lm(final$Tuberculosis ~ final$Year + final$Employment + final$Population + final$GDP + final$Coverage + final$GovtExp + final$PublicExp + final$Country)
summary(m2Tub)

m2Pne = lm(final$Pneumonia ~ final$Year + final$Employment + final$Population + final$GDP + final$Coverage + final$GovtExp + final$PublicExp + final$Country)
summary(m2Pne)

m2Neo = lm(final$Neoplasms~ final$Year + final$Employment + final$Population + final$GDP + final$Coverage + final$GovtExp + final$PublicExp + final$Country)
summary(m2Neo)
```
This model for HIV had an R-squared of 0.7729, an increase of 0.5456 from our previous model.

This model for Influenza had an R-squared of 0.4816, an increase of 0.1814 from our previous model.

This model for Tuberculosis had an R-squared of 0.8994, an increase of 0.5419 from our previous model.

This model for Pneumonia has an R-squared of 0.8126, an increase of 0.5407 from our previous model.

This model for Neoplasms had an R-squared of 0.9648, an increase of 0.5907 from our previous model.

So HIV, Tuberculosis, Pneumonia and Neoplasms are all heavily effected by variables that we do not have that are baked in to each of our countries, while Influenza is only mildly effected by these variables.

To get a visual idea of how good this model is, let's look at this graph showing the actual HIV rate in Australia from 1990-2016 vs our predicted HIV rate in Australia from 1990-2016.
```{r}
Aus = final[final$Country=="Australia",]
prediction = predict.lm(mHIV, Aus)
prediction = prediction[1:26]

ggplot(Aus, aes(x = Year, y = HIV)) +
     geom_point() +
  geom_line(aes(y = prediction), size = 1)

```

Finding optimal lambdas for glm
```{r}
set.seed(42)


testH = na.omit(final[,-4:-7])


x1 <- testH %>% select(Year, Employment, Population, GDP, Coverage, GovtExp, PublicExp) %>% data.matrix()
y1 <- testH$HIV
lambdas <- 10^seq(3, -10, by = -.1)
cv_fit <- cv.glmnet(x1, y1, alpha = .8, lambda = lambdas)

cv_fit$lambda.min
temp = final[,-3]
test2 = na.omit(temp[,-4:-6])


x2 <- test2 %>% select(Year, Employment, Population, GDP, Coverage, GovtExp, PublicExp) %>% data.matrix()
y2 <- test2$Influenza
lambdas <- 10^seq(1, -8, by = -.1)
cv_fit2 <- cv.glmnet(x2, y2, alpha = .8, lambda = lambdas)
cv_fit2$lambda.min
temp = final[,-3:-4]
test3 = na.omit(temp[,-4:-5])

x3 <- test3 %>% select(Year, Employment, Population, GDP, Coverage, GovtExp, PublicExp) %>% data.matrix()
y3 <- test3$Tuberculosis

cv_fit3 <- cv.glmnet(x3, y3, alpha = .8, lambda = lambdas)
cv_fit3$lambda.min

temp = final[,-3:-5]
test4 = na.omit(temp[,-4])

x4 <- test4 %>% select(Year, Employment, Population, GDP, Coverage, GovtExp, PublicExp) %>% data.matrix()
y4 <- test4$Neoplasms

cv_fit4 <- cv.glmnet(x4, y4, alpha = .8, lambda = lambdas)
cv_fit4$lambda.min

temp = final[,-3:-6]
test5 = na.omit(temp)

x5 <- test5 %>% select(Year, Employment, Population, GDP, Coverage, GovtExp, PublicExp) %>% data.matrix()
y5 <- test5$Pneumonia

cv_fit5 <- cv.glmnet(x5, y5, alpha = .8, lambda = lambdas)
cv_fit5$lambda.min

```

Messing around with training and test data, test data for lm is wonky
```{r}
set.seed(42)
train = sample(1:nrow(x1), nrow(x1)/2)

View(train)

x1_train = x1[train,]
y1_train = y1[train]
x1_test = x1[-train,]
y1_test = y1[-train]


fit1 <- glmnet(x1_train, y1_train, alpha = .8, lambda = 0.0158)

preds <- predict(fit1,newx = x1_test)
actual <- y1_test
rss <- sum((preds - actual) ^ 2)
tss <- sum((actual - mean(actual)) ^ 2)
rsq <- 1 - rss/tss
rsq
length(y1_test)
mHIV = lm(y1_train ~ x1_train)

preds2 <- predict(mHIV, y1_test[1])
length(actual)
rss <- sum((preds2 - actual) ^ 2)
tss <- sum((actual - mean(actual)) ^ 2)
rsq <- 1 - rss/tss
rsq

binded = cbind(preds,preds2,actual)
binded
```


Messing around with PCA
```{r}

set.seed(42)

temp = na.omit(final)

dim(temp)
train = sample(1:nrow(temp), nrow(temp)/2)
temp.pca <- prcomp(na.omit(cbind(temp[,2],temp[8:13])))
summary(temp.pca)

temp$PC1 <- temp.pca$x[,1]
temp$PC2 <- temp.pca$x[,2]
ggplot(temp, aes(x = PC1, y = PC2, colour = as.factor(temp$HIV))) + geom_point()

ggplot(poverty, aes(x = PC1, y = PC2, colour = as.factor(poverty))) + geom_point()+ geom_text(aes(label = State))

ggplot(poverty, aes(x = PC1, y = PC2, colour = as.factor(poverty$k4))) + geom_point()+ geom_text(aes(label = State))

coef(fit1)
summary(mHIV)
tree.HIV = tree(HIV ~Year + Employment + Population + GDP + Coverage + GovtExp + PublicExp, temp[-train,])
summary(tree.HIV)
View(tree.HIV)
preds <- predict(tree.HIV,newx = temp[-train,])
actual <- temp[-train,3]
rss <- sum((preds - actual) ^ 2)
tss <- sum((actual - mean(actual)) ^ 2)
rsq <- 1 - rss/tss
rsq

final[-train,3]
actual
fo
```


Tree analysis
```{r}

set.seed(42)

temp = na.omit(final)
train = sample(1:nrow(temp), nrow(temp)/2)
temp.pca <- prcomp(na.omit(cbind(temp[,2],temp[8:13])))
tree.HIV = tree(HIV ~Year + Employment + Population + GDP + Coverage + GovtExp + PublicExp, temp[-train,])

preds <- predict(tree.HIV,newx = temp[-train,])
actual <- temp[-train,3]
rss <- sum((preds - actual) ^ 2)
tss <- sum((actual - mean(actual)) ^ 2)
rsq1 <- 1 - rss/tss
rsq1

tree.Flu = tree(Influenza ~Year + Employment + Population + GDP + Coverage + GovtExp + PublicExp, temp[-train,])
preds <- predict(tree.Flu,newx = temp[-train,])
actual <- temp[-train,4]
rss <- sum((preds - actual) ^ 2)
tss <- sum((actual - mean(actual)) ^ 2)
rsq2 <- 1 - rss/tss
rsq2

tree.Tub = tree(Tuberculosis ~Year + Employment + Population + GDP + Coverage + GovtExp + PublicExp, temp[-train,])
preds <- predict(tree.Tub,newx = temp[-train,])
actual <- temp[-train,5]
rss <- sum((preds - actual) ^ 2)
tss <- sum((actual - mean(actual)) ^ 2)
rsq3 <- 1 - rss/tss
rsq3

tree.Neo = tree(Neoplasms ~Year + Employment + Population + GDP + Coverage + GovtExp + PublicExp, temp[-train,])
preds <- predict(tree.Neo,newx = temp[-train,])
actual <- temp[-train,6]
rss <- sum((preds - actual) ^ 2)
tss <- sum((actual - mean(actual)) ^ 2)
rsq4 <- 1 - rss/tss
rsq4

tree.Pne = tree(Pneumonia ~Year + Employment + Population + GDP + Coverage + GovtExp + PublicExp, temp[-train,])
preds <- predict(tree.Pne,newx = temp[-train,])
actual <- temp[-train,7]
rss <- sum((preds - actual) ^ 2)
tss <- sum((actual - mean(actual)) ^ 2)
rsq5 <- 1 - rss/tss
rsq5
```

